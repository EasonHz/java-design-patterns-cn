# 备忘录模式（Memento Pattern）

## 介绍

- 它用于将对象的状态恢复到以前的状态。
- 在不破坏封装的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态，这样可以在以后将对象恢复到原先保存的状态。
- 客户端不与备忘录类耦合，与备忘录的管理类耦合。
- 备忘录模式是在三个对象的帮助下实现的： `originator`, `caretaker`,  `memento`
	1. `Originator `：需要存储其内部状态的对象。`Originator`对象创建一个`Memento`对象来存储其内部状态。因此，`Originator`对象知道如何保存和恢复自身。获取和设置`Memento`对象值的对象。
	2. `Caretaker`：知道`Originator`需要保存和恢复自身的原因和时间。它维护了创建的`Memento`对象的历史记录。
	3. `Memento`：包含基本状态存储和检索功能的POJO对象。`Memento`对象通常是不可变的。存储了`Originato`r的内部状态，并允许其恢复。
- Git存储是备忘录模式的一个例子。

## 实现

案例：以员工信息为例

`Employee`代码 

```java
@ToString
public class Employee {

    protected int empId;
    protected String name;
    protected String designation;
    protected long salary;
    protected String department;
    protected String project;

    public Employee(int empId) {
        super();
        this.empId = empId;
    }

    public int getEmpId() {
        return empId;
    }

    public String getName() {
        return name;
    }

    public Employee setName(String name) {
        this.name = name;
        return this;
    }

    public String getDesignation() {
        return designation;
    }

    public Employee setDesignation(String designation) {
        this.designation = designation;
        return this;
    }

    public long getSalary() {
        return salary;
    }

    public Employee setSalary(long salary) {
        this.salary = salary;
        return this;
    }

    public String getDepartment() {
        return department;
    }

    public Employee setDepartment(String department) {
        this.department = department;
        return this;
    }

    public String getProject() {
        return project;
    }

    public Employee setProject(String project) {
        this.project = project;
        return this;
    }

    /**
     * 创建备忘录
     *
     * @return 备忘录
     */
    public EmployeeMemento createMemento() {
        return new EmployeeMemento(empId, name, designation, salary, department, project);
    }

    /**
     * 恢复备忘录
     *
     * @param memento 要恢复的记录
     */
    public void restore(EmployeeMemento memento) {
        if (memento != null) {
            this.empId = memento.empId;
            this.name = memento.name;
            this.designation = memento.designation;
            this.salary = memento.salary;
            this.department = memento.department;
            this.project = memento.project;
        } else {
                System.err.println("Can't restore without memento object!");
        }
    }
}
```

`EmployeeMemento`代码

```java
@Data
@ToString
public class EmployeeMemento {

	protected int empId;
	protected String name;
	protected String designation;
	protected long salary;
	protected String department;
	protected String project;

	public EmployeeMemento(int empId, String name, String designation, long salary, String department, String project) {
		super();
		this.empId = empId;
		this.name = name;
		this.designation = designation;
		this.salary = salary;
		this.department = department;
		this.project = project;
	}
	
}
```

`EmployeeCaretaker`代码

```java
public class EmployeeCaretaker {

	protected Map<Integer, Map<String, EmployeeMemento>> mementoHistory = new HashMap<>();

	public void addMemento(int empId, String mementoMessage, EmployeeMemento memento) {
		if (mementoMessage != null && mementoMessage.trim().length() != 0 && memento != null) {
			Map<String, EmployeeMemento> mementoMessageMap = mementoHistory.computeIfAbsent(empId, k -> new HashMap<>());
			mementoMessageMap.put(mementoMessage, memento);
			System.out.printf("员工 '%s' 的信息快照，存储在消息 '%s' 中.\n", memento.getName(), mementoMessage);
		}
	}

	public EmployeeMemento getMemento(int empId, String mementoMessage) {
		EmployeeMemento memento = null;
		if (mementoMessage != null && mementoMessage.trim().length() != 0) {
			Map<String, EmployeeMemento> mementoMessageMap = mementoHistory.get(empId);
			if (mementoMessageMap != null) {
				memento = mementoMessageMap.get(mementoMessage);
				if (memento != null) {
					System.out.printf("已还原员工 '%s' 的信息快照，其中包含消息 '%s' \n", memento.getName(), mementoMessage);
				} else {
					System.err.println("找不到该条备忘录!");
				}
			}
		}
		return memento;
	}

	public void printStoredMementoObjects() {
		System.out.println("======================================================");
		mementoHistory.forEach((empId, mementoMessageMap) -> {
			mementoMessageMap.forEach((message, memento) -> {
				System.out.printf("EmpId: '%d', Message: '%s', Memento: '%s'\n", empId, message, memento);
			});
		});
		System.out.println("======================================================");
	}

}
```

测试和执行程序`Main`

```java
public class Main {

	public static void main(String[] args) {
		EmployeeCaretaker caretaker = new EmployeeCaretaker();
		System.out.println("创建员工对象...");
		Employee zhangSan = new Employee(100).setName("张三").setDesignation("Lead").setSalary(100000).setDepartment("R&D").setProject("Transportation Management");
		Employee liSi = new Employee(101).setName("李四").setDesignation("Developer").setSalary(75000).setDepartment("Engineering").setProject("IoT");
		System.out.println(zhangSan);
		System.out.println(liSi);
		//创建备忘录
		EmployeeMemento zhangSanMemento = zhangSan.createMemento();
		EmployeeMemento liSiMemento = liSi.createMemento();
		//添加备忘录
		caretaker.addMemento(zhangSan.getEmpId(), "Saved at intitial stage", zhangSanMemento);
		caretaker.addMemento(liSi.getEmpId(), "Saved at intitial stage",liSiMemento);

		System.out.println("\n张三升职了");
		zhangSan.setDesignation("Manager").setSalary(120000);
		System.out.println("李四被分配到了另一个项目组");
		liSi.setProject("Android App");
		System.out.println(zhangSan);
		System.out.println(liSi);
		//创建备忘录
		zhangSanMemento = zhangSan.createMemento();
		liSiMemento = liSi.createMemento();
		//添加备忘录
		caretaker.addMemento(zhangSan.getEmpId(), "Saved at promotion", zhangSanMemento);
		caretaker.addMemento(liSi.getEmpId(), "Saved at android project",liSiMemento);


		System.out.println("\n张三涨工资拉");
		zhangSan.setSalary(140000);
		System.out.println("李四升职啦");
		liSi.setDesignation("Lead Developer").setSalary(90000);
		System.out.println(zhangSan);
		System.out.println(liSi);
		//创建备忘录
		zhangSanMemento = zhangSan.createMemento();
		liSiMemento = liSi.createMemento();
		//添加备忘录
		caretaker.addMemento(zhangSan.getEmpId(), "Saved at increment", zhangSanMemento);
		caretaker.addMemento(liSi.getEmpId(), "Saved at promotion",liSiMemento);


		System.out.println("\n打印出所有的备忘录");
		caretaker.printStoredMementoObjects();


		System.out.println("\n现在，因为一些原因，需要张三恢复到原始状态.");
		System.out.println("并且让李四回到Android项目.");
		zhangSanMemento = caretaker.getMemento(zhangSan.getEmpId(), "Saved at intitial stage");
		liSiMemento = caretaker.getMemento(liSi.getEmpId(), "Saved at android project");
		//恢复备忘录
		zhangSan.restore(zhangSanMemento);
		liSi.restore(liSiMemento);
		System.out.println(zhangSan);
		System.out.println(liSi);
	}

}

```

结果输出：

```java
创建员工对象...
Employee [empId=100, name=张三, designation=Lead, salary=100000, department=R&D, project=Transportation Management]
Employee [empId=101, name=李四, designation=Developer, salary=75000, department=Engineering, project=IoT]
员工 '张三' 的信息快照，存储在消息 'Saved at intitial stage' 中.
员工 '李四' 的信息快照，存储在消息 'Saved at intitial stage' 中.

张三升职了
李四被分配到了另一个项目组
Employee [empId=100, name=张三, designation=Manager, salary=120000, department=R&D, project=Transportation Management]
Employee [empId=101, name=李四, designation=Developer, salary=75000, department=Engineering, project=Android App]
员工 '张三' 的信息快照，存储在消息 'Saved at promotion' 中.
员工 '李四' 的信息快照，存储在消息 'Saved at android project' 中.

张三涨工资拉
李四升职啦
Employee [empId=100, name=张三, designation=Manager, salary=140000, department=R&D, project=Transportation Management]
Employee [empId=101, name=李四, designation=Lead Developer, salary=90000, department=Engineering, project=Android App]
员工 '张三' 的信息快照，存储在消息 'Saved at increment' 中.
员工 '李四' 的信息快照，存储在消息 'Saved at promotion' 中.

打印出所有的备忘录
======================================================
EmpId: '100', Message: 'Saved at increment', Memento: 'EmployeeMemento(empId=100, name=张三, designation=Manager, salary=140000, department=R&D, project=Transportation Management)'
EmpId: '100', Message: 'Saved at intitial stage', Memento: 'EmployeeMemento(empId=100, name=张三, designation=Lead, salary=100000, department=R&D, project=Transportation Management)'
EmpId: '100', Message: 'Saved at promotion', Memento: 'EmployeeMemento(empId=100, name=张三, designation=Manager, salary=120000, department=R&D, project=Transportation Management)'
EmpId: '101', Message: 'Saved at intitial stage', Memento: 'EmployeeMemento(empId=101, name=李四, designation=Developer, salary=75000, department=Engineering, project=IoT)'
EmpId: '101', Message: 'Saved at android project', Memento: 'EmployeeMemento(empId=101, name=李四, designation=Developer, salary=75000, department=Engineering, project=Android App)'
EmpId: '101', Message: 'Saved at promotion', Memento: 'EmployeeMemento(empId=101, name=李四, designation=Lead Developer, salary=90000, department=Engineering, project=Android App)'
======================================================

现在，因为一些原因，需要张三恢复到原始状态.
并且让李四回到Android项目.
已还原员工 '张三' 的信息快照，其中包含消息 'Saved at intitial stage' 
已还原员工 '李四' 的信息快照，其中包含消息 'Saved at android project' 
Employee [empId=100, name=张三, designation=Lead, salary=100000, department=R&D, project=Transportation Management]
Employee [empId=101, name=李四, designation=Developer, salary=75000, department=Engineering, project=Android App]

```



## 总结

**优点**

-  给用户提供了一种可以恢复状态的机制，可以使用户能够比较方便地回到某个历史的状态。
-  实现了信息的封装，使得用户不需要关心状态的保存细节。

**缺点**

- 消耗资源。如果类的成员变量过多，势必会占用比较大的资源，而且每一次保存都会消耗一定的内存。

**使用场景** 

- 需要保存/恢复数据的相关状态场景。 
- 提供一个可回滚的操作。

**经典案例**

[java.util.Date](http://docs.oracle.com/javase/8/docs/api/java/util/Date.html)

**注意事项**

- 我们可以通过使用序列化使备忘录模式更通用；这将消除每个类都有自己的`Memento`类的要求。
- 备忘录模式还可以与命令设计模式一起使用，以实现命令的撤销。
- 为了节约内存，可使用原型模式+备忘录模式。

















